<!DOCTYPE html>

    <script>

        safari.application.addEventListener("beforeSearch", beforeSearchHandler, true);
        safari.application.addEventListener("beforeNavigate", beforeNavigateHandler, true);
        //safari.application.addEventListener("navigate", navigateHandler, true);

        // Called _after_ url load
        function navigateHandler(event) {
            alert("navigate event: "+event.url)
            //            event.preventDefault()
        }

        // called every time the address bar thinks it has an url
        function beforeNavigateHandler(event) {
            queryHandler(event.url)
            //alert("beforeNavigate event: "+event.url)
            //            event.preventDefault()
        }

        function beforeSearchHandler(event) {
            //alert("beforeSearch event: "+event.query)
            queryHandler(event.query)
        }

        function queryHandler(query) {
            // read the address bar
            //var curUrl = window.location.toString()
            var curUrl = query

            // capture groups always result in the equivalent number of entries in the array.
            var regExp = /.?(\/ipfs\/|\/ipns\/)?(Qm\w{44})/
            var regExcl = /http:\/\/localhost.*/
            var matches = regExp.exec(curUrl)

            // If matches is not null it will always have 3 elements, some of 
            // which may be null.
            if (matches != null) {

                if (matches.length > 1 && !regExcl.test(curUrl)) {

                    // matches[1] is the protocol.
                    var proto = matches[1]
                    defaultProto = (proto == null) ? "/ipfs/" : proto

                    // matches[2] is the hash.
                    var hash = matches[2]
                    if( hash != null ) {
                        defaultProto += hash
                        var newUrl = "http://localhost:8080"+defaultProto
                        var theTab = safari.application.activeBrowserWindow.activeTab
                        theTab.url = newUrl 
            //alert(matches)

                        // Needed to avoid Safari throwing a "No internet" page on top.
                        event.preventDefault()
                    }
                }
            } 
        }

    </script>

