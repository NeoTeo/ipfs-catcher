<!DOCTYPE html>

    <script>

        /// This event only fires when the query doesn't begin with http or https
        safari.application.addEventListener("beforeSearch", beforeSearchHandler, true);
        safari.application.addEventListener("beforeNavigate", beforeNavigateHandler, true);
        //safari.application.addEventListener("navigate", navigateHandler, true);

        // Called _after_ url load
        function navigateHandler(event) {
            alert("navigate event: "+event.url)
            //            event.preventDefault()
        }

        // called every time the address bar thinks it has an url.
        // Also called as soon as the queryHandler sets the urlbar
        function beforeNavigateHandler(event) {
            //alert("beforeNavigate event: "+event.url+"   at: "+event.timeStamp)
            /// update timeout and only handle the event on timeout.
            if(queryHandler(event.query, true) == true) {
                alert("fire!")
                queryHandler(query, false)
            preventDefault()
            event.preventDefault()
                return
            } 
        }

        function beforeSearchHandler(event) {
            
            var result = queryHandler(event.query, false)
           
            if( result != "" ) {
                var theTab = safari.application.activeBrowserWindow.activeTab
                theTab.url = result 
                event.preventDefault()
            }
        }

        function queryHandler(query) {
            // read the address bar
            //var curUrl = window.location.toString()
            var curUrl = query

            // capture groups always result in the equivalent number of entries in the array.
            var regExp = /.?(\/ipfs\/|\/ipns\/)?(Qm\w{44})/
            var regExcl = /http:\/\/localhost.*/
            var matches = regExp.exec(curUrl)

            // If matches is not null it will always have 3 elements, some of 
            // which may be null.
            if (matches != null) {

                if (matches.length > 1 && !regExcl.test(curUrl)) {

                    // matches[1] is the protocol.
                    var proto = matches[1]
                    defaultProto = (proto == null) ? "/ipfs/" : proto

                    // matches[2] is the hash.
                    var hash = matches[2]
                    if( hash != null ) {
                        defaultProto += hash
                        var newUrl = "http://localhost:8080"+defaultProto
                        //var theTab = safari.application.activeBrowserWindow.activeTab
                            /// This causes beforeNavigateHander to get called and never comes past the preventDefault() 
                            //theTab.url = newUrl 
                            // Needed to avoid Safari throwing a "No internet" page on top.
                        return newUrl 
                    }
                }
            } 
            return "" 
        }

    </script>

